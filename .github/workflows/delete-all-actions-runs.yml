name: Manual Delete Actions History

on:
  workflow_dispatch:

permissions:
  actions: write
  contents: read

jobs:
  delete-actions-history:
    runs-on: ubuntu-latest

    steps:
      - name: Delete ALL Actions runs (manual)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OWNER: ${{ github.repository_owner }}
          REPO: ${{ github.event.repository.name }}
        run: |
          set -e

          echo "Start deleting Actions history..."

          PAGE=1
          PER_PAGE=100

          while true; do
            RUN_IDS=$(curl -s \
              -H "Authorization: Bearer $GH_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/${OWNER}/${REPO}/actions/runs?per_page=${PER_PAGE}&page=${PAGE}" \
              | jq -r '.workflow_runs[].id')

            if [ -z "$RUN_IDS" ]; then
              echo "No more Actions runs found."
              break
            fi

            for RUN_ID in $RUN_IDS; do
              echo "Deleting run ID: $RUN_ID"
              curl -s -X DELETE \
                -H "Authorization: Bearer $GH_TOKEN" \
                -H "Accept: application/vnd.github+json" \
                "https://api.github.com/repos/${OWNER}/${REPO}/actions/runs/${RUN_ID}"
            done

            PAGE=$((PAGE + 1))
          done

          echo "DONE: All Actions history deleted."
          
