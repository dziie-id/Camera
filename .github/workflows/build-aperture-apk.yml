name: Quick Build Aperture

on:
  workflow_dispatch:
    inputs:
      enable_aux:
        description: 'Enable AUX camera support'
        required: true
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
    
    - name: Check Aperture source
      run: |
        if [ ! -d "aperture_camera" ]; then
          echo "Cloning Aperture Camera..."
          git clone --depth=1 https://github.com/LineageOS/android_packages_apps_Aperture.git aperture_camera
        fi
        
        echo "Aperture source ready"
    
    - name: Create minimal build files
      run: |
        cd aperture_camera
        
        # Create minimal build.gradle if needed
        if [ ! -f "build.gradle" ]; then
          cat > build.gradle << 'EOF'
plugins {
    id 'com.android.application'
}

android {
    compileSdk 34
    
    defaultConfig {
        applicationId "org.lineageos.aperture"
        minSdk 33
        targetSdk 34
        versionCode 1
        versionName "1.0"
    }
    
    buildTypes {
        release {
            minifyEnabled false
        }
        debug {
            debuggable true
        }
    }
}

dependencies {
    implementation 'androidx.appcompat:appcompat:1.6.1'
    implementation 'androidx.camera:camera-core:1.3.0'
    implementation 'androidx.camera:camera-camera2:1.3.0'
}
EOF
        fi
        
        # Create directory structure
        mkdir -p src/main/java/org/lineageos/aperture
        mkdir -p src/main/res
        
        echo "Build files created"
    
    - name: Build APK
      run: |
        cd aperture_camera
        
        # Try to build
        ./gradlew assembleDebug || ./gradlew build
        
        # Find and copy APK
        APK=$(find . -name "*.apk" -type f | head -1)
        
        if [ -n "$APK" ]; then
          echo "APK found: $APK"
          cp "$APK" ../aperture-built.apk
          echo "✅ Build successful"
        else
          echo "❌ No APK found"
          exit 1
        fi
    
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: aperture-apk
        path: aperture-built.apk
