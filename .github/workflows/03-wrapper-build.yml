name: Step 3 - Inject Wrapper Smali

on:
  workflow_dispatch:

jobs:
  wrapper:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Download base GCamGo
        run: |
          mkdir -p base
          curl -L -o base/GCamGo.apk \
          https://1-dontsharethislink.celsoazevedo.com/file/filesc/MGCLite_3.8.476835377_V7_ENG.apk

      - name: Install apktool
        run: |
          sudo apt update
          sudo apt install -y apktool

      - name: Decode APK
        run: |
          apktool d base/GCamGo.apk -o work --force

      - name: Copy wrapper smali
        run: |
          mkdir -p work/smali/wrapper
          cp smali/Wrapper.smali work/smali/wrapper/Wrapper.smali

      - name: Patch AndroidManifest
        run: |
          sed -i 's|</application>|\
          <activity android:name="wrapper.Wrapper" \
          android:exported="true" \
          android:theme="@android:style/Theme.Translucent.NoTitleBar.Fullscreen">\
            <intent-filter>\
              <action android:name="android.intent.action.MAIN"/>\
              <category android:name="android.intent.category.LAUNCHER"/>\
            </intent-filter>\
          </activity>\
          </application>|' work/AndroidManifest.xml

      - name: Build APK unsigned
        run: |
          apktool b work -o Camera-unsigned.apk

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: wrapper-unsigned
          path: Camera-unsigned.apk
