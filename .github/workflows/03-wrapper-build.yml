name: Step 3 - Build Wrapper APK

on:
  workflow_dispatch:

jobs:
  build-wrapper:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Setup JDK
      uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: 17

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    # ================================
    # 1️⃣ COMPILE JAVA → .class
    # ================================
    - name: Compile Wrapper Java
      run: |
        mkdir -p out/classes
        javac -source 8 -target 8 \
          -classpath $ANDROID_HOME/platforms/android-34/android.jar \
          -d out/classes \
          $(find app/src -name "*.java")

    # ================================
    # 2️⃣ JAR-IN CLASS (INI KUNCI!)
    # ================================
    - name: Create wrapper.jar
      run: |
        cd out/classes
        jar cf ../wrapper.jar .
        cd ../..

    # ================================
    # 3️⃣ D8 → classes.dex (AMAN)
    # ================================
    - name: Convert jar to classes.dex
      run: |
        BUILD_TOOLS=$(ls $ANDROID_HOME/build-tools | sort -V | tail -n 1)
        $ANDROID_HOME/build-tools/$BUILD_TOOLS/d8 \
          --min-api 26 \
          --output out \
          out/wrapper.jar

    # ================================
    # 4️⃣ BUILD UNSIGNED APK (ZIP)
    # ================================
    - name: Build unsigned APK
      run: |
        mkdir -p apk
        cp -r app/res apk/
        cp app/AndroidManifest.xml apk/
        cp out/classes.dex apk/
        cd apk
        zip -r ../Camera-unsigned.apk .
        cd ..

    # ================================
    # 5️⃣ UPLOAD RESULT
    # ================================
    - name: Upload unsigned APK
      uses: actions/upload-artifact@v4
      with:
        name: Camera-unsigned
        path: Camera-unsigned.apk
