name: Build Camera Wrapper

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Compile Java
        run: |
          mkdir -p out/classes
          javac \
            -source 8 -target 8 \
            -classpath $ANDROID_HOME/platforms/android-34/android.jar \
            -d out/classes \
            app/src/org/lineageos/aperture/WrapperActivity.java

      - name: Convert to DEX
        run: |
          d8 $(find out/classes -name "*.class") --output out

      - name: Package APK
        run: |
          $ANDROID_HOME/build-tools/34.0.0/aapt2 link \
            -I $ANDROID_HOME/platforms/android-34/android.jar \
            --manifest app/AndroidManifest.xml \
            -o Camera-unsigned.apk \
            out/classes.dex

      - name: Sign APK
        run: |
          $ANDROID_HOME/build-tools/34.0.0/apksigner sign \
            --key keystore/Key.pk8 \
            --cert keystore/Key.x509.pem \
            --out Camera.apk \
            Camera-unsigned.apk

      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          files: Camera.apk
