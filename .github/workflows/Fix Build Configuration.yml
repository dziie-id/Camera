      <category android:name="android.intent.category.DEFAULT" />
                <data android:mimeType="video/*" />
            </intent-filter>
            
            <!-- View camera files -->
            <intent-filter>
                <action android:name="android.intent.action.VIEW" />
                <category android:name="android.intent.category.DEFAULT" />
                <category android:name="android.intent.category.BROWSABLE" />
                <data android:mimeType="image/*" />
                <data android:mimeType="video/*" />
            </intent-filter>
            
            <!-- Camera shortcut -->
            <meta-data
                android:name="android.app.shortcuts"
                android:resource="@xml/shortcuts" />
        </activity>
        
        <!-- Camera Settings Activity -->
        <activity
            android:name=".SettingsActivity"
            android:exported="false"
            android:label="@string/title_activity_settings"
            android:theme="@style/Theme.Aperture.Settings" />
        
        <!-- Gallery Activity -->
        <activity
            android:name=".GalleryActivity"
            android:exported="false"
            android:configChanges="orientation|screenSize"
            android:theme="@style/Theme.Aperture.Transparent" />
        
        <!-- Camera Service (background processing) -->
        <service
            android:name=".camera.CameraService"
            android:exported="false"
            android:enabled="true"
            android:isolatedProcess="false" />
            
        <!-- Camera Broadcast Receiver -->
        <receiver
            android:name=".camera.CameraBroadcastReceiver"
            android:exported="false"
            android:enabled="true">
            <intent-filter>
                <action android:name="android.hardware.action.NEW_PICTURE" />
                <action android:name="android.hardware.action.NEW_VIDEO" />
                <action android:name="android.intent.action.MEDIA_SCANNER_SCAN_FILE" />
            </intent-filter>
        </receiver>
        
        <!-- File Provider for Camera files -->
        <provider
            android:name="androidx.core.content.FileProvider"
            android:authorities="\${applicationId}.fileprovider"
            android:exported="false"
            android:grantUriPermissions="true">
            <meta-data
                android:name="android.support.FILE_PROVIDER_PATHS"
                android:resource="@xml/file_paths" />
        </provider>
        
        <!-- Camera metadata -->
        <meta-data
            android:name="com.android.camera"
            android:value="true" />
            
        <!-- Supports picture-in-picture mode -->
        <meta-data
            android:name="android.app.picture_in_picture"
            android:resource="@xml/picture_in_picture" />
            
        <!-- Camera extensions -->
        <meta-data
            android:name="androidx.camera.extensions"
            android:value="HDR, NIGHT, FACE_RETOUCH, BOKEH, AUTO" />
            
        <!-- App compatibility -->
        <meta-data
            android:name="android.max_aspect"
            android:value="2.1" />
    </application>

</manifest>
EOF
        
        echo "✓ Created fixed AndroidManifest.xml"
        echo ""
        
        # Create manifest validation
        echo "=== MANIFEST VALIDATION SUMMARY ==="
        echo ""
        echo "Permissions added:"
        echo "1. android.permission.CAMERA"
        echo "2. android.permission.RECORD_AUDIO"
        echo "3. android.permission.READ/WRITE_EXTERNAL_STORAGE"
        echo "4. android.permission.ACCESS_FINE_LOCATION"
        echo "5. android.permission.ACCESS_MEDIA_LOCATION"
        echo "6. READ_MEDIA_IMAGES/VIDEO (Android 13+)"
        echo ""
        echo "Hardware features declared:"
        echo "1. android.hardware.camera (required)"
        echo "2. android.hardware.camera.autofocus (optional)"
        echo "3. android.hardware.camera.flash (optional)"
        echo "4. android.hardware.camera.any (optional)"
        echo "5. Multi-camera support features"
        echo ""
        echo "Camera2 API features:"
        echo "✓ Camera extensions declared"
        echo "✓ File provider configured"
        echo "✓ Intent filters for camera actions"
        echo "✓ Network security config"
        
        cat > fixed_aperture_build/manifests/MANIFEST_SUMMARY.md << 'EOF'
        # AndroidManifest.xml Fix Summary
        
        ## Fixed Issues:
        1. ✅ Added Camera2 API permissions
        2. ✅ Added hardware feature declarations
        3. ✅ Added aux camera support features
        4. ✅ Added scoped storage permissions
        5. ✅ Added Android 13+ media permissions
        6. ✅ Added camera extension metadata
        7. ✅ Added network security configuration
        8. ✅ Added intent filters for camera actions
        
        ## Key Features:
        - No root/system permissions required
        - Standard Camera2 API usage
        - Multi-camera (aux) support
        - Scoped storage compliant
        - Android 13+ compatible
        
        ## Location:
        Original: source/aperture_camera/AndroidManifest.xml
        Fixed: fixed_aperture_build/manifests/AndroidManifest.fixed.xml
        EOF

  create-gradle-build:
    needs: setup-fixed-directory
    if: github.event.inputs.step_to_run == 'all' || github.event.inputs.step_to_run == 'gradle'
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Create standalone build.gradle
      run: |
        echo "=== CREATING STANDALONE BUILD.GRADLE ==="
        echo ""
        
        cat > fixed_aperture_build/gradle_configs/build.gradle << 'EOF'
// ============================================
// Standalone Aperture Camera APK Build Configuration
// Auto-generated for Redmi Note 13 4G (sapphire)
// NO ROOT / NO MODULES REQUIRED
// ============================================

plugins {
    id 'com.android.application'
    id 'kotlin-android'
    id 'kotlin-kapt'
    id 'kotlin-parcelize'
    id 'androidx.navigation.safeargs.kotlin'
}

// Apply version plugin for auto-increment
apply plugin: 'com.android.application'

android {
    namespace '${{ github.event.inputs.package_name }}'
    compileSdk 34
    
    defaultConfig {
        applicationId "${{ github.event.inputs.package_name }}"
        minSdk 29  // Android 10 - Required for CameraX and aux camera support
        targetSdk 34
        versionCode 10000
        versionName "1.0.0-standalone"
        
        testInstrumentationRunner "androidx.test.runner.AndroidJUnitRunner"
        
        // Camera2 API requirements
        buildConfigField "boolean", "ENABLE_AUX_CAMERAS", "true"
        buildConfigField "boolean", "ENABLE_CAMERA2_API", "true"
        buildConfigField "int", "MAX_CAMERAS_SUPPORTED", "4"
        buildConfigField "int", "DEFAULT_CAMERA_ID", "0"
        
        // Device-specific configurations for Redmi Note 13 4G
        buildConfigField "String", "DEVICE_CODENAME", '"sapphire"'
        buildConfigField "String", "DEVICE_MANUFACTURER", '"Xiaomi"'
        buildConfigField "String", "DEVICE_MODEL", '"Redmi Note 13 4G"'
        buildConfigField "String", "BUILD_TYPE", '"STANDALONE_APK"'
        
        // Vector drawable support
        vectorDrawables {
            useSupportLibrary true
        }
        
        // MultiDex for large app
        multiDexEnabled true
        
        // ABI filters for Redmi Note 13 4G
        ndk {
            abiFilters 'armeabi-v7a', 'arm64-v8a'
        }
    }
    
    signingConfigs {
        debug {
            storeFile file('debug.keystore')
            storePassword 'android'
            keyAlias 'androiddebugkey'
            keyPassword 'android'
        }
        
        release {
            // These should be configured in gradle.properties
            storeFile file(System.getenv("RELEASE_STORE_FILE") ?: "release.keystore")
            storePassword System.getenv("RELEASE_STORE_PASSWORD") ?: ""
            keyAlias System.getenv("RELEASE_KEY_ALIAS") ?: ""
            keyPassword System.getenv("RELEASE_KEY_PASSWORD") ?: ""
        }
    }
    
    buildTypes {
        debug {
            debuggable true
            minifyEnabled false
            shrinkResources false
            proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
            signingConfig signingConfigs.debug
            
            buildConfigField "boolean", "LOG_DEBUG", "true"
            buildConfigField "boolean", "ENABLE_CRASHLYTICS", "false"
            buildConfigField "String", "BUILD_VARIANT", '"DEBUG"'
        }
        
        release {
            debuggable false
            minifyEnabled true
            shrinkResources true
            proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
            signingConfig signingConfigs.release
            
            buildConfigField "boolean", "LOG_DEBUG", "false"
            buildConfigField "boolean", "ENABLE_CRASHLYTICS", "true"
            buildConfigField "String", "BUILD_VARIANT", '"RELEASE"'
        }
        
        // Special build for aux camera testing
        auxTest {
            initWith debug
            applicationIdSuffix ".auxtest"
            versionNameSuffix "-aux-test"
            
            buildConfigField "boolean", "ENABLE_AUX_CAMERAS", "true"
            buildConfigField "boolean", "FORCE_AUX_MODE", "true"
            buildConfigField "String", "BUILD_VARIANT", '"AUX_TEST"'
            
            matchingFallbacks = ['debug']
        }
    }
    
    compileOptions {
        // Java 11 for CameraX compatibility
        sourceCompatibility JavaVersion.VERSION_11
        targetCompatibility JavaVersion.VERSION_11
        
        // Enable core library desugaring for newer APIs
        coreLibraryDesugarin      <category android:name="android.intent.category.DEFAULT" />
                <data android:mimeType="video/*" />
            </intent-filter>
            
            <!-- View camera files -->
            <intent-filter>
                <action android:name="android.intent.action.VIEW" />
                <category android:name="android.intent.category.DEFAULT" />
                <category android:name="android.intent.category.BROWSABLE" />
                <data android:mimeType="image/*" />
                <data android:mimeType="video/*" />
            </intent-filter>
            
            <!-- Camera shortcut -->
            <meta-data
                android:name="android.app.shortcuts"
                android:resource="@xml/shortcuts" />
        </activity>
        
        <!-- Camera Settings Activity -->
        <activity
            android:name=".SettingsActivity"
            android:exported="false"
            android:label="@string/title_activity_settings"
            android:theme="@style/Theme.Aperture.Settings" />
        
        <!-- Gallery Activity -->
        <activity
            android:name=".GalleryActivity"
            android:exported="false"
            android:configChanges="orientation|screenSize"
            android:theme="@style/Theme.Aperture.Transparent" />
        
        <!-- Camera Service (background processing) -->
        <service
            android:name=".camera.CameraService"
            android:exported="false"
            android:enabled="true"
            android:isolatedProcess="false" />
            
        <!-- Camera Broadcast Receiver -->
        <receiver
            android:name=".camera.CameraBroadcastReceiver"
            android:exported="false"
            android:enabled="true">
            <intent-filter>
                <action android:name="android.hardware.action.NEW_PICTURE" />
                <action android:name="android.hardware.action.NEW_VIDEO" />
                <action android:name="android.intent.action.MEDIA_SCANNER_SCAN_FILE" />
            </intent-filter>
        </receiver>
        
        <!-- File Provider for Camera files -->
        <provider
            android:name="androidx.core.content.FileProvider"
            android:authorities="\${applicationId}.fileprovider"
            android:exported="false"
            android:grantUriPermissions="true">
            <meta-data
                android:name="android.support.FILE_PROVIDER_PATHS"
                android:resource="@xml/file_paths" />
        </provider>
        
        <!-- Camera metadata -->
        <meta-data
            android:name="com.android.camera"
            android:value="true" />
            
        <!-- Supports picture-in-picture mode -->
        <meta-data
            android:name="android.app.picture_in_picture"
            android:resource="@xml/picture_in_picture" />
            
        <!-- Camera extensions -->
        <meta-data
            android:name="androidx.camera.extensions"
            android:value="HDR, NIGHT, FACE_RETOUCH, BOKEH, AUTO" />
            
        <!-- App compatibility -->
        <meta-data
            android:name="android.max_aspect"
            android:value="2.1" />
    </application>

</manifest>
EOF
        
        echo "✓ Created fixed AndroidManifest.xml"
        echo ""
        
        # Create manifest validation
        echo "=== MANIFEST VALIDATION SUMMARY ==="
        echo ""
        echo "Permissions added:"
        echo "1. android.permission.CAMERA"
        echo "2. android.permission.RECORD_AUDIO"
        echo "3. android.permission.READ/WRITE_EXTERNAL_STORAGE"
        echo "4. android.permission.ACCESS_FINE_LOCATION"
        echo "5. android.permission.ACCESS_MEDIA_LOCATION"
        echo "6. READ_MEDIA_IMAGES/VIDEO (Android 13+)"
        echo ""
        echo "Hardware features declared:"
        echo "1. android.hardware.camera (required)"
        echo "2. android.hardware.camera.autofocus (optional)"
        echo "3. android.hardware.camera.flash (optional)"
        echo "4. android.hardware.camera.any (optional)"
        echo "5. Multi-camera support features"
        echo ""
        echo "Camera2 API features:"
        echo "✓ Camera extensions declared"
        echo "✓ File provider configured"
        echo "✓ Intent filters for camera actions"
        echo "✓ Network security config"
        
        cat > fixed_aperture_build/manifests/MANIFEST_SUMMARY.md << 'EOF'
        # AndroidManifest.xml Fix Summary
        
        ## Fixed Issues:
        1. ✅ Added Camera2 API permissions
        2. ✅ Added hardware feature declarations
        3. ✅ Added aux camera support features
        4. ✅ Added scoped storage permissions
        5. ✅ Added Android 13+ media permissions
        6. ✅ Added camera extension metadata
        7. ✅ Added network security configuration
        8. ✅ Added intent filters for camera actions
        
        ## Key Features:
        - No root/system permissions required
        - Standard Camera2 API usage
        - Multi-camera (aux) support
        - Scoped storage compliant
        - Android 13+ compatible
        
        ## Location:
        Original: source/aperture_camera/AndroidManifest.xml
        Fixed: fixed_aperture_build/manifests/AndroidManifest.fixed.xml
        EOF

  create-gradle-build:
    needs: setup-fixed-directory
    if: github.event.inputs.step_to_run == 'all' || github.event.inputs.step_to_run == 'gradle'
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Create standalone build.gradle
      run: |
        echo "=== CREATING STANDALONE BUILD.GRADLE ==="
        echo ""
        
        cat > fixed_aperture_build/gradle_configs/build.gradle << 'EOF'
// ============================================
// Standalone Aperture Camera APK Build Configuration
// Auto-generated for Redmi Note 13 4G (sapphire)
// NO ROOT / NO MODULES REQUIRED
// ============================================

plugins {
    id 'com.android.application'
    id 'kotlin-android'
    id 'kotlin-kapt'
    id 'kotlin-parcelize'
    id 'androidx.navigation.safeargs.kotlin'
}

// Apply version plugin for auto-increment
apply plugin: 'com.android.application'

android {
    namespace '${{ github.event.inputs.package_name }}'
    compileSdk 34
    
    defaultConfig {
        applicationId "${{ github.event.inputs.package_name }}"
        minSdk 29  // Android 10 - Required for CameraX and aux camera support
        targetSdk 34
        versionCode 10000
        versionName "1.0.0-standalone"
        
        testInstrumentationRunner "androidx.test.runner.AndroidJUnitRunner"
        
        // Camera2 API requirements
        buildConfigField "boolean", "ENABLE_AUX_CAMERAS", "true"
        buildConfigField "boolean", "ENABLE_CAMERA2_API", "true"
        buildConfigField "int", "MAX_CAMERAS_SUPPORTED", "4"
        buildConfigField "int", "DEFAULT_CAMERA_ID", "0"
        
        // Device-specific configurations for Redmi Note 13 4G
        buildConfigField "String", "DEVICE_CODENAME", '"sapphire"'
        buildConfigField "String", "DEVICE_MANUFACTURER", '"Xiaomi"'
        buildConfigField "String", "DEVICE_MODEL", '"Redmi Note 13 4G"'
        buildConfigField "String", "BUILD_TYPE", '"STANDALONE_APK"'
        
        // Vector drawable support
        vectorDrawables {
            useSupportLibrary true
        }
        
        // MultiDex for large app
        multiDexEnabled true
        
        // ABI filters for Redmi Note 13 4G
        ndk {
            abiFilters 'armeabi-v7a', 'arm64-v8a'
        }
    }
    
    signingConfigs {
        debug {
            storeFile file('debug.keystore')
            storePassword 'android'
            keyAlias 'androiddebugkey'
            keyPassword 'android'
        }
        
        release {
            // These should be configured in gradle.properties
            storeFile file(System.getenv("RELEASE_STORE_FILE") ?: "release.keystore")
            storePassword System.getenv("RELEASE_STORE_PASSWORD") ?: ""
            keyAlias System.getenv("RELEASE_KEY_ALIAS") ?: ""
            keyPassword System.getenv("RELEASE_KEY_PASSWORD") ?: ""
        }
    }
    
    buildTypes {
        debug {
            debuggable true
            minifyEnabled false
            shrinkResources false
            proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
            signingConfig signingConfigs.debug
            
            buildConfigField "boolean", "LOG_DEBUG", "true"
            buildConfigField "boolean", "ENABLE_CRASHLYTICS", "false"
            buildConfigField "String", "BUILD_VARIANT", '"DEBUG"'
        }
        
        release {
            debuggable false
            minifyEnabled true
            shrinkResources true
            proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
            signingConfig signingConfigs.release
            
            buildConfigField "boolean", "LOG_DEBUG", "false"
            buildConfigField "boolean", "ENABLE_CRASHLYTICS", "true"
            buildConfigField "String", "BUILD_VARIANT", '"RELEASE"'
        }
        
        // Special build for aux camera testing
        auxTest {
            initWith debug
            applicationIdSuffix ".auxtest"
            versionNameSuffix "-aux-test"
            
            buildConfigField "boolean", "ENABLE_AUX_CAMERAS", "true"
            buildConfigField "boolean", "FORCE_AUX_MODE", "true"
            buildConfigField "String", "BUILD_VARIANT", '"AUX_TEST"'
            
            matchingFallbacks = ['debug']
        }
    }
    
    compileOptions {
        // Java 11 for CameraX compatibility
        sourceCompatibility JavaVersion.VERSION_11
        targetCompatibility JavaVersion.VERSION_11
        
        // Enable core library desugaring for newer APIs
        coreLibraryDesugarin
