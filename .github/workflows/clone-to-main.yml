name: Clone Directly to Repository

on:
  workflow_dispatch:
    inputs:
      branch_name:
        description: 'Branch name for the cloned content'
        required: true
        default: 'sapphire-sources'
        type: string
      cleanup_first:
        description: 'Delete existing folders first'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  clone-direct:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: main
        fetch-depth: 0
    
    - name: Create or switch to target branch
      run: |
        # Create or checkout the target branch
        git checkout -b ${{ github.event.inputs.branch_name }} 2>/dev/null || git checkout ${{ github.event.inputs.branch_name }}
        
        if [ "${{ github.event.inputs.cleanup_first }}" = "true" ]; then
          echo "Cleaning up existing directories..."
          rm -rf device_xiaomi_sapphire vendor_xiaomi_sapphire kernel_xiaomi_sapphire aperture_camera
        fi
    
    - name: Clone Device Tree
      run: |
        echo "Cloning Device Tree..."
        if [ -d "device_xiaomi_sapphire" ]; then
          echo "Device Tree already exists. Skipping..."
        else
          git clone --depth=1 https://github.com/saroj-nokia/device_xiaomi_sapphire.git
          rm -rf device_xiaomi_sapphire/.git
          echo "✓ Device Tree cloned"
        fi
    
    - name: Clone Vendor Tree
      run: |
        echo "Cloning Vendor Tree..."
        if [ -d "vendor_xiaomi_sapphire" ]; then
          echo "Vendor Tree already exists. Skipping..."
        else
          git clone --depth=1 https://github.com/saroj-nokia/vendor_xiaomi_sapphire.git
          rm -rf vendor_xiaomi_sapphire/.git
          echo "✓ Vendor Tree cloned"
        fi
    
    - name: Clone Kernel Source
      run: |
        echo "Cloning Kernel Source..."
        if [ -d "kernel_xiaomi_sapphire" ]; then
          echo "Kernel Source already exists. Skipping..."
        else
          git clone --depth=1 https://github.com/saroj-nokia/device_xiaomi_sapphire-kernel.git kernel_xiaomi_sapphire
          rm -rf kernel_xiaomi_sapphire/.git
          echo "✓ Kernel Source cloned"
        fi
    
    - name: Clone Aperture Camera
      run: |
        echo "Cloning Aperture Camera..."
        if [ -d "aperture_camera" ]; then
          echo "Aperture Camera already exists. Skipping..."
        else
          git clone --depth=1 https://github.com/LineageOS/android_packages_apps_Aperture.git aperture_camera
          rm -rf aperture_camera/.git
          # Remove any .gitmodules files inside
          find aperture_camera -name ".gitmodules" -delete
          echo "✓ Aperture Camera cloned"
        fi
    
    - name: Create manifest file
      run: |
        cat > SOURCES_MANIFEST.md << 'EOF'
        # Android Sources for Redmi Note 14G NFC (Sapphire)
        
        ## Cloned Repositories
        
        | Repository | URL | Cloned As |
        |------------|-----|-----------|
        | Device Tree | https://github.com/saroj-nokia/device_xiaomi_sapphire.git | `device_xiaomi_sapphire/` |
        | Vendor Tree | https://github.com/saroj-nokia/vendor_xiaomi_sapphire.git | `vendor_xiaomi_sapphire/` |
        | Kernel Source | https://github.com/saroj-nokia/device_xiaomi_sapphire-kernel.git | `kernel_xiaomi_sapphire/` |
        | Aperture Camera | https://github.com/LineageOS/android_packages_apps_Aperture.git | `aperture_camera/` |
        
        ## Device Information
        - **Device**: Redmi Note 14G NFC
        - **Codename**: sapphire
        - **Cloned Date**: $(date)
        
        ## Usage Notes
        - These are direct clones, not submodules
        - Git histories have been removed
        - All files are directly in this repository
        EOF
    
    - name: Commit changes
      run: |
        # Configure git
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        # Add all files
        git add .
        
        # Check if there are changes
        if git diff --cached --quiet; then
          echo "No changes to commit"
        else
          git commit -m "feat: Add Redmi Note 14G NFC sources directly to repo
        
        Added the following cloned repositories:
        
        1. Device Tree (sapphire)
        2. Vendor Tree (sapphire)
        3. Kernel Source (sapphire)
        4. Aperture Camera app
        
        Cloned from original sources on $(date)
        
        This is a direct copy, not a submodule reference."
        fi
    
    - name: Push to repository
      run: |
        git push --set-upstream origin ${{ github.event.inputs.branch_name }}
        echo "✅ Successfully pushed to branch: ${{ github.event.inputs.branch_name }}"
    
    - name: Create Pull Request (Optional)
      if: ${{ github.event.inputs.branch_name != 'main' }}
      run: |
        # Check if PR already exists
        PR_EXISTS=$(gh pr view --json number 2>/dev/null || echo "{}")
        
        if [ "$PR_EXISTS" = "{}" ]; then
          gh pr create \
            --title "Add Redmi Note 14G NFC (Sapphire) sources" \
            --body "This PR adds cloned Android sources for Redmi Note 14G NFC (sapphire):
            
            - Device Tree from saroj-nokia
            - Vendor Tree from saroj-nokia
            - Kernel Source from saroj-nokia
            - Aperture Camera from LineageOS
            
            All repositories are cloned directly into this repo (no submodules)." \
            --base main \
            --head ${{ github.event.inputs.branch_name }}
        else
          echo "Pull request already exists"
        fi
      env:
        GH_TOKEN: ${{ secrets.PAT_TOKEN }}
