name: Build Camera Wrapper (Step 1–3)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # STEP 0 — Checkout
      - name: Checkout repo
        uses: actions/checkout@v4

      # STEP 1 — Setup Java
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      # STEP 2 — Install apktool (dependency minimal)
      # Install apktool JAR (stable)
      - name: Download apktool jar
        run: |
            curl -L https://bitbucket.org/iBotPeaches/apktool/downloads/apktool_2.9.3.jar -o apktool.jar

      # STEP 3 — Download GCam Go (langsung dari Celso)
      - name: Download GCam Go APK
        run: |
          mkdir -p base
          curl -L \
            "https://1-dontsharethislink.celsoazevedo.com/file/filesc/MGCLite_3.8.476835377_V7_ENG.apk" \
            -o base/GCamGo.apk
          ls -lh base/GCamGo.apk

      # STEP 4 — Decode APK
      - name: Decode GCam Go
        run: |
           java -Xmx4g -jar apktool.jar d base/GCamGo.apk -o work

      # STEP 5 — Info (debug ringan)
      - name: Check decoded structure
        run: |
          echo "==== work folder ===="
          ls work
          echo "==== work/smali ===="
          ls work/smali | head -n 5

      # STEP 6 — Build unsigned APK
      - name: Build unsigned APK
        run: |
           java -Xmx6g -jar apktool.jar b work -o Camera-unsigned.apk
           ls -lh Camera-unsigned.apk
    
      # STEP 7 — Upload unsigned APK
      - name: Upload unsigned APK
        uses: actions/upload-artifact@v4
        with:
          name: camera-unsigned
          path: Camera-unsigned.apk

          # STEP 8 — Setup Android SDK Build-Tools (for apksigner)
      - name: Setup Android SDK Build-Tools
        uses: android-actions/setup-android@v3

      # STEP 9 — Sign APK (platform key style)
      - name: Sign APK
        run: |
          BUILD_TOOLS=$(ls $ANDROID_HOME/build-tools | sort -V | tail -n 1)
          $ANDROID_HOME/build-tools/$BUILD_TOOLS/apksigner sign \
            --key keystore/Key.pk8 \
            --cert keystore/Key.x509.pem \
            --out Camera.apk \
            Camera-unsigned.apk

          echo "Signed APK:"
          ls -lh Camera.apk

      # STEP 10 — Create Git tag (required for Release)
      - name: Create tag
        run: |
          TAG="v$(date +%Y%m%d-%H%M%S)"
          git tag $TAG
          git push origin $TAG

      # STEP 11 — Upload to GitHub Release
      - name: Upload Release
        uses: softprops/action-gh-release@v2
        with:
          files: Camera.apk
