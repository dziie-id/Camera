name: Build Aperture Sapphire - Android 16 QPR2 Final

on:
  workflow_dispatch:

jobs:
  build_process:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 1. SETUP VERSIONING & CLEANUP
      - name: Prepare Workspace
        id: vars
        run: |
          echo "TAG_NAME=v16-build36-$(date +'%Y%m%d')" >> $GITHUB_OUTPUT
          # Jangan hapus seluruh folder fixed_aperture_build karena ada kunci di sana
          rm -rf build_src/
          mkdir -p fixed_aperture_build/output

      # 2. SETUP JDK 21
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      # 3. FRESH CLONE SOURCE
      - name: Clone Aperture Source
        run: |
          git clone https://github.com/LineageOS/android_packages_apps_Aperture.git build_src
          echo "ROOT=$GITHUB_WORKSPACE/build_src" >> $GITHUB_ENV

      # 4. HARD-PATCH VERSION, PACKAGE & FEATURES
      - name: Hard-Patching Source Code
        run: |
          cd $ROOT
          # Force Package Name: org.lineageos.aperture
          # Force Version Name: 16
          # Force Version Code (Code Name): 36
          find . -name "*.gradle" -exec sed -i 's/applicationId "[^"]*"/applicationId "org.lineageos.aperture"/g' {} +
          find . -name "*.gradle" -exec sed -i 's/versionCode [0-9]*/versionCode 36/g' {} +
          find . -name "*.gradle" -exec sed -i 's/versionName "[^"]*"/versionName "16"/g' {} +
          
          # Hard-Patch Java agar Experimental Menu & Developer Menu SELALU TRUE
          find . -name "*.java" -o -name "*.kt" | xargs sed -i 's/return .*EXPERIMENTAL_FEATURES.*/return true;/g' 2>/dev/null || true
          find . -name "*.java" -o -name "*.kt" | xargs sed -i 's/return .*DEVELOPER_MENU.*/return true;/g' 2>/dev/null || true
          
          # Patch SDK 35 (Android 16 QPR2)
          find . -name "*.gradle" -exec sed -i 's/compileSdkVersion [0-9]*/compileSdkVersion 35/g' {} +
          find . -name "*.gradle" -exec sed -i 's/targetSdkVersion [0-9]*/targetSdkVersion 35/g' {} +

          # Injeksi Flag Tambahan ke BuildConfig
          find . -name "*.gradle" -exec sed -i '/defaultConfig {/a \        buildConfigField "String", "DEVICE_CODENAME", "\"36\""\n        buildConfigField "boolean", "FORCE_AUX_MODES", "true"\n        buildConfigField "boolean", "EXPERIMENTAL_FEATURES", "true"\n        buildConfigField "boolean", "DEVELOPER_MENU", "true"' {} +

      # 5. OVERLAY KONFIGURASI HARDWARE (AUX FORCED)
      - name: Setup Hardware Overlays
        run: |
          RES_DIR="build_src/app/src/main/res/values"
          mkdir -p $RES_DIR
          cat > $RES_DIR/config_sapphire_fix.xml <<EOF
          <?xml version="1.0" encoding="utf-8"?>
          <resources>
              <bool name="config_multiCameraSupport">true</bool>
              <bool name="config_forceShowAux">true</bool>
              <string name="config_aux_camera_ids">0,1,2,3</string>
              <string-array name="config_aux_package_allowlist">
                  <item>org.lineageos.aperture</item>
              </string-array>
          </resources>
          EOF

      # 6. BUILD APK (RELEASE)
      - name: Build APK
        run: |
          cd $ROOT
          chmod +x gradlew
          ./gradlew assembleRelease

      # 7. ZIPALIGN & SIGN WITH PEM/PK8 (Folder fixed_aperture_build)
      - name: Optimize & Sign with Custom Keys
        run: |
          BUILD_TOOLS_DIR=$(ls -d $ANDROID_HOME/build-tools/* | tail -1)
          RAW_APK=$(find $ROOT -name "*release-unsigned.apk" -o -name "*release.apk" | head -n 1)
          
          # Path ke kunci Anda di folder fixed_aperture_build
          KEY_PEM="fixed_aperture_build/Key_20260125_203517.x509.pem"
          KEY_PK8="fixed_aperture_build/Key_20260125_203517.pk8"
          
          # Zipalign
          $BUILD_TOOLS_DIR/zipalign -v 4 "$RAW_APK" fixed_aperture_build/output/aligned.apk
          
          # Sign menggunakan file kunci yang ditaruh di folder fixed_aperture_build
          $BUILD_TOOLS_DIR/apksigner sign --key "$KEY_PK8" \
            --cert "$KEY_PEM" \
            --v1-signing-enabled true --v2-signing-enabled true --v3-signing-enabled true --v4-signing-enabled true \
            --out fixed_aperture_build/output/Aperture-v16-Sapphire-Signed.apk \
            fixed_aperture_build/output/aligned.apk

      # 8. CREATE GITHUB RELEASE
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.vars.outputs.TAG_NAME }}
          name: Aperture Sapphire v16 (Code 36)
          body: |
            ### ðŸ“¸ Aperture v16 Build 36
            - **Package Name:** `org.lineageos.aperture`
            - **Version:** 16 (Build 36)
            - **Signer:** Custom Platform Keys (PEM/PK8)
            - **Features:** Hard-patched Experimental Menu, Forced AUX (0,1,2,3).
          files: fixed_aperture_build/output/Aperture-v16-Sapphire-Signed.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
