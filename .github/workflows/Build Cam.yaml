name: Build Aperture Sapphire - Android 16 QPR2 Ready

on:
  workflow_dispatch:
    inputs:
      package_name:
        description: 'Package Name'
        required: true
        default: 'org.lineageos.aperture'
        type: string

jobs:
  build_process:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Mengambil seluruh history untuk memastikan semua file ada

      # 1. SETUP JDK 21
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      # 2. SETUP STRUKTUR OUTPUT & AUX CONFIG
      - name: Setup Output & Sapphire Config
        run: |
          mkdir -p fixed_aperture_build/{aux_camera_configs,signing_configs,output}
          cat > fixed_aperture_build/aux_camera_configs/org.lineageos.aperture.xml <<EOF
          <?xml version="1.0" encoding="utf-8"?>
          <resources>
              <string-array name="config_aux_package_allowlist">
                  <item>${{ github.event.inputs.package_name }}</item>
              </string-array>
              <string-array name="config_vendor_id_allowlist">
                  <item>0</item> <item>1</item> <item>2</item> <item>3</item>
              </string-array>
          </resources>
          EOF

      # 3. IDENTIFIKASI PROJECT ROOT (DIPERBAIKI)
      - name: Identify Project Root
        id: project_info
        run: |
          echo "Searching for build.gradle..."
          # Mencari build.gradle tanpa batasan maxdepth agar lebih akurat
          # Mengabaikan folder hasil build kita sendiri
          SEARCH_RESULT=$(find . -name "build.gradle" | grep -v "fixed_aperture_build" | head -n 1)
          
          if [ -z "$SEARCH_RESULT" ]; then
            echo "❌ ERROR: build.gradle tidak ditemukan di mana pun!"
            ls -R # List semua file untuk debugging
            exit 1
          fi
          
          REAL_ROOT=$(dirname "$SEARCH_RESULT")
          echo "ROOT=$REAL_ROOT" >> $GITHUB_OUTPUT
          echo "✓ Project ditemukan di: $REAL_ROOT"

      # 4. PATCH ANDROID 16 & FIX SDK
      - name: Patch for Android 16
        run: |
          cd "${{ steps.project_info.outputs.ROOT }}"
          # Update SDK ke 35 (Android 16 Ready)
          find . -name "*.gradle" -exec sed -i 's/compileSdkVersion [0-9]*/compileSdkVersion 35/g' {} +
          find . -name "*.gradle" -exec sed -i 's/targetSdkVersion [0-9]*/targetSdkVersion 35/g' {} +
          
          # Force buildConfig dan ignore lint
          find . -name "*.gradle" -exec sed -i '/android {/a \    buildFeatures { buildConfig true }\n    lintOptions { checkReleaseBuilds false; abortOnError false }' {} +

      # 5. GENERATE KEYSTORE
      - name: Generate Keystore
        run: |
          KEYSTORE_FILE="fixed_aperture_build/signing_configs/release.keystore"
          rm -f "$KEYSTORE_FILE"
          keytool -genkey -v -keystore "$KEYSTORE_FILE" \
            -alias aperture_key -keyalg RSA -keysize 2048 -validity 10000 \
            -dname "CN=Aperture, OU=LineageOS, O=CustomROM, L=Jakarta, C=ID" \
            -storepass password123 -keypass password123

      # 6. INJECT GRADLE WRAPPER
      - name: Inject Gradle
        run: |
          cd "${{ steps.project_info.outputs.ROOT }}"
          # Menggunakan Gradle 8.10 (terbaru & stabil untuk JDK 21)
          gradle wrapper --gradle-version 8.10
          chmod +x gradlew

      # 7. BUILD RELEASE APK
      - name: Build APK
        run: |
          cd "${{ steps.project_info.outputs.ROOT }}"
          ./gradlew assembleRelease --stacktrace

      # 8. ZIPALIGN & SIGN V4 (Android 16 Standard)
      - name: Optimize & Sign
        run: |
          BUILD_TOOLS_DIR=$(ls -d $ANDROID_HOME/build-tools/* | tail -1)
          RAW_APK=$(find "${{ steps.project_info.outputs.ROOT }}" -name "*-release.apk" | head -n 1)
          
          if [ -z "$RAW_APK" ]; then
            echo "❌ ERROR: APK tidak ditemukan setelah build!"
            exit 1
          fi
          
          $BUILD_TOOLS_DIR/zipalign -v 4 "$RAW_APK" fixed_aperture_build/output/aligned.apk
          $BUILD_TOOLS_DIR/apksigner sign --ks fixed_aperture_build/signing_configs/release.keystore \
            --ks-key-alias aperture_key --ks-pass pass:password123 --key-pass pass:password123 \
            --v1-signing-enabled true --v2-signing-enabled true --v3-signing-enabled true --v4-signing-enabled true \
            --out fixed_aperture_build/output/Aperture-Sapphire-A16.apk \
            fixed_aperture_build/output/aligned.apk

      # 9. PUSH & ARTIFACT
      - name: Push Results
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          rm -f fixed_aperture_build/output/aligned.apk
          git add .
          git commit -m "Build: Aperture for Android 16 [skip ci]" || echo "No changes"
          git push origin main
      
      - name: Final Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Aperture-Sapphire-A16
          path: fixed_aperture_build/output/Aperture-Sapphire-A16.apk
