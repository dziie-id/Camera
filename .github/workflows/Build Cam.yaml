name: Fix Build Configuration Step by Step

on:
  workflow_dispatch:
    inputs:
      step_to_run:
        description: 'Select which step to run'
        required: true
        default: 'all'
        type: choice
        options:
          - 'all'
          - 'setup'
          - 'manifest'
          - 'gradle'
          - 'proguard'
          - 'aux_config'
          - 'signing'
          - 'assets'
          - 'summary'
      package_name:
        description: 'Package name for standalone APK'
        required: true
        default: 'com.lycodump.aperture.standalone'
        type: string

jobs:
  setup_fixed_directory:
    if: ${{ github.event.inputs.step_to_run == 'all' || github.event.inputs.step_to_run == 'setup' }}
    runs-on: ubuntu-latest
    steps:
      - name: Create fixed build directory
        run: |
          mkdir -p fixed_aperture_build/{configs,manifests,gradle_configs,proguard_configs,aux_camera_configs,signing_configs,assets,output}
          echo "✓ Directory structure created"

  create_manifest_file:
    needs: setup_fixed_directory
    if: ${{ always() && (github.event.inputs.step_to_run == 'all' || github.event.inputs.step_to_run == 'manifest') }}
    runs-on: ubuntu-latest
    steps:
      - name: Generate Manifest
        run: |
          package_name="${{ github.event.inputs.package_name }}"
          cat > fixed_aperture_build/manifests/AndroidManifest.fixed.xml <<EOF
          <?xml version="1.0" encoding="utf-8"?>
          <manifest xmlns:android="http://schemas.android.com/apk/res/android" package="$package_name">
            <uses-permission android:name="android.permission.CAMERA" />
            <uses-permission android:name="android.permission.RECORD_AUDIO" />
            <application android:label="Aperture Sapphire" android:theme="@style/Theme.Aperture">
              <activity android:name=".MainActivity" android:exported="true" />
            </application>
          </manifest>
          EOF

  create_gradle_files:
    needs: setup_fixed_directory
    if: ${{ always() && (github.event.inputs.step_to_run == 'all' || github.event.inputs.step_to_run == 'gradle') }}
    runs-on: ubuntu-latest
    steps:
      - name: Generate Gradle Config
        run: |
          package_name="${{ github.event.inputs.package_name }}"
          cat > fixed_aperture_build/gradle_configs/build.gradle <<EOF
          android {
              namespace '$package_name'
              compileSdk 34
              defaultConfig {
                  applicationId "$package_name"
                  minSdk 29
                  targetSdk 34
                  buildConfigField "String", "DEVICE_CODENAME", '"sapphire"'
              }
          }
          EOF

  create_camera_config:
    needs: setup_fixed_directory
    if: ${{ always() && (github.event.inputs.step_to_run == 'all' || github.event.inputs.step_to_run == 'aux_config') }}
    runs-on: ubuntu-latest
    steps:
      - name: Create Sapphire Camera XML
        run: |
          cat > fixed_aperture_build/aux_camera_configs/camera_config_sapphire.xml <<EOF
          <camera-config>
            <sensors>
              <sensor id="0" type="back" name="IMX582" />
              <sensor id="1" type="front" name="OV13B10" />
              <sensor id="2" type="aux" name="GC02M1" purpose="macro" />
            </sensors>
          </camera-config>
          EOF

  setup_signing:
    needs: setup_fixed_directory
    if: ${{ always() && (github.event.inputs.step_to_run == 'all' || github.event.inputs.step_to_run == 'signing') }}
    runs-on: ubuntu-latest
    steps:
      - name: Generate Signing Script
        run: |
          cat > fixed_aperture_build/signing_configs/generate_keystore.sh <<EOF
          #!/bin/bash
          keytool -genkey -v -keystore release.keystore -alias aperture -keyalg RSA -keysize 2048 -validity 10000
          EOF
          chmod +x fixed_aperture_build/signing_configs/generate_keystore.sh
          echo "✓ Keystore generation script ready"

  generate_summary:
    needs: [setup_fixed_directory, create_manifest_file, create_gradle_files, create_camera_config, setup_signing]
    if: ${{ always() }}
    runs-on: ubuntu-latest
    steps:
      - name: Create Final Summary
        run: |
          cat > fixed_aperture_build/FIXED_BUILD_SUMMARY.md <<EOF
          # Build Fix Summary
          - Device: Redmi Note 13 4G (sapphire)
          - Status: Configuration Ready
          - Output: Check artifacts for files.
          EOF
      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: sapphire-build-package
          path: fixed_aperture_build/
