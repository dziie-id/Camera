name: Build Aperture Sapphire - Android 16 QPR2 Final

on:
  workflow_dispatch:

jobs:
  build_process:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 1. SETUP WORKSPACE
      - name: Prepare Workspace
        id: vars
        run: |
          echo "TAG_NAME=v16-b36-$(date +'%Y%m%d-%H%M')" >> $GITHUB_OUTPUT
          rm -rf build_src/
          mkdir -p fixed_aperture_build/output

      # 2. SETUP JDK 21
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      # 3. FRESH CLONE SOURCE
      - name: Clone Aperture Source
        run: |
          git clone https://github.com/LineageOS/android_packages_apps_Aperture.git build_src
          echo "ROOT=$GITHUB_WORKSPACE/build_src" >> $GITHUB_ENV

      # 4. HARD-OVERRIDE VERSIONING & EXPERIMENTAL (FIX PASTI BERHASIL)
      - name: Force Version 16 & Code 36
        run: |
          cd $ROOT
          # Mencari file gradle utama yang berisi versi (biasanya app/build.gradle atau app/build.gradle.kts)
          GRADLE_FILE=$(find . -name "build.gradle" | grep "/app/")
          
          # Force Override Versioning menggunakan sed yang lebih kuat
          sed -i 's/versionCode [0-9]*/versionCode 36/g' "$GRADLE_FILE"
          sed -i 's/versionName "[^"]*"/versionName "16"/g' "$GRADLE_FILE"
          sed -i 's/applicationId "[^"]*"/applicationId "org.lineageos.aperture"/g' "$GRADLE_FILE"
          
          # Force Enable Experimental & Developer Menu di level logik Java
          # Kami mencari fungsi penentu fitur dan mengganti return value-nya menjadi true
          find . -type f -name "*.java" -o -name "*.kt" | xargs sed -i 's/return .*EXPERIMENTAL_FEATURES.*/return true;/g' 2>/dev/null || true
          find . -type f -name "*.java" -o -name "*.kt" | xargs sed -i 's/return .*DEVELOPER_MENU.*/return true;/g' 2>/dev/null || true
          
          # Paksa compile ke SDK 35 agar fitur Android 16 terbuka
          sed -i 's/compileSdkVersion [0-9]*/compileSdkVersion 35/g' "$GRADLE_FILE"
          sed -i 's/targetSdkVersion [0-9]*/targetSdkVersion 35/g' "$GRADLE_FILE"
          
          echo "âœ“ Verifikasi File Gradle:"
          grep -E "versionCode|versionName|applicationId" "$GRADLE_FILE"

      # 5. INJECT HARDWARE OVERLAY (FORCE AUX CAMERA)
      - name: Force AUX Camera Config
        run: |
          RES_DIR="build_src/app/src/main/res/values"
          mkdir -p $RES_DIR
          cat > $RES_DIR/config_sapphire_hard_fix.xml <<EOF
          <?xml version="1.0" encoding="utf-8"?>
          <resources>
              <bool name="config_multiCameraSupport">true</bool>
              <bool name="config_forceShowAux">true</bool>
              <string name="config_aux_camera_ids">0,1,2,3,4</string>
              <string-array name="config_aux_package_allowlist">
                  <item>org.lineageos.aperture</item>
              </string-array>
          </resources>
          EOF

      # 6. BUILD APK
      - name: Build APK
        run: |
          cd $ROOT
          chmod +x gradlew
          ./gradlew assembleRelease

      # 7. SIGN WITH YOUR CUSTOM PEM/PK8 KEYS
      - name: Sign with Custom Keys
        run: |
          BUILD_TOOLS_DIR=$(ls -d $ANDROID_HOME/build-tools/* | tail -1)
          RAW_APK=$(find $ROOT -name "*release-unsigned.apk" -o -name "*release.apk" | head -n 1)
          
          # Path kunci Anda
          KEY_PEM="fixed_aperture_build/Key_20260125_203517.x509.pem"
          KEY_PK8="fixed_aperture_build/Key_20260125_203517.pk8"
          
          $BUILD_TOOLS_DIR/zipalign -v 4 "$RAW_APK" fixed_aperture_build/output/aligned.apk
          $BUILD_TOOLS_DIR/apksigner sign --key "$KEY_PK8" --cert "$KEY_PEM" \
            --v1-signing-enabled true --v2-signing-enabled true --v3-signing-enabled true --v4-signing-enabled true \
            --out fixed_aperture_build/output/Aperture-v16-Final.apk \
            fixed_aperture_build/output/aligned.apk

      # 8. UPLOAD RELEASE
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.vars.outputs.TAG_NAME }}
          name: Aperture Sapphire v16 Build 36
          body: |
            ### ðŸ›  Fix Update:
            - **Version Name:** 16 (Fixed)
            - **Version Code:** 36 (Fixed)
            - **AUX Camera:** Forced ID 0,1,2,3,4
            - **Experimental Menu:** Hard-coded to ALWAYS TRUE
          files: fixed_aperture_build/output/Aperture-v16-Final.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
