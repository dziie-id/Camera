name: One-Click Clone All Sources

on:
  workflow_dispatch:
    inputs:
      push_to_main:
        description: 'Push directly to main branch?'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

permissions:
  contents: write

jobs:
  clone-all:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Clone all sources in one go
      run: |
        # Create a clean function
        clean_clone() {
          repo_url=$1
          target_dir=$2
          
          echo "ðŸ“¥ Cloning: $repo_url"
          
          # Clone with minimal history
          git clone --depth=1 "$repo_url" "$target_dir"
          
          # Remove all git-related files
          find "$target_dir" -name ".git" -type d -exec rm -rf {} + 2>/dev/null || true
          find "$target_dir" -name ".gitmodules" -type f -delete 2>/dev/null || true
          find "$target_dir" -name ".gitignore" -type f -delete 2>/dev/null || true
          
          echo "âœ… Saved to: $target_dir"
          echo ""
        }
        
        echo "ðŸš€ Starting clone process..."
        echo "========================================"
        
        # Clone all repositories
        clean_clone "https://github.com/saroj-nokia/device_xiaomi_sapphire.git" "device"
        clean_clone "https://github.com/saroj-nokia/vendor_xiaomi_sapphire.git" "vendor"
        clean_clone "https://github.com/saroj-nokia/device_xiaomi_sapphire-kernel.git" "kernel"
        clean_clone "https://github.com/LineageOS/android_packages_apps_Aperture.git" "packages/apps/Aperture"
        
        echo "========================================"
        echo "ðŸŽ‰ All sources cloned successfully!"
        
        # Create summary file
        cat > CLONING_SUMMARY.txt << 'EOF'
        SOURCES CLONED SUCCESSFULLY
        ===========================
        
        Repository List:
        1. Device Tree     -> device/
        2. Vendor Tree     -> vendor/
        3. Kernel Source   -> kernel/
        4. Aperture Camera -> packages/apps/Aperture/
        
        All git histories have been removed.
        Files are now directly in this repository.
        
        Generated by GitHub Actions
        Timestamp: $(date)
        EOF
    
    - name: Push to repository
      if: ${{ github.event.inputs.push_to_main == 'true' }}
      run: |
        # Configure git
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        
        # Add everything
        git add -A
        
        # Check for changes
        if git diff --cached --quiet; then
          echo "No changes to commit"
          exit 0
        fi
        
        # Commit
        git commit -m "feat: Add all Android sources for Redmi Note 14G NFC
        
        This commit adds the complete set of Android sources needed for
        Redmi Note 14G NFC (sapphire) development:
        
        â€¢ device/ - Device tree configuration
        â€¢ vendor/ - Vendor binaries and blobs  
        â€¢ kernel/ - Kernel source code
        â€¢ packages/apps/Aperture/ - Camera application
        
        Sources were cloned directly (not as submodules) on $(date)."
        
        # Push
        git push
        echo "âœ… Pushed all sources to main branch"
