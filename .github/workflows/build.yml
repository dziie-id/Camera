name: Build Camera APK (Manual Trigger)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # =========================
      # STEP 1: CHECKOUT REPO
      # =========================
      - name: Checkout source
        uses: actions/checkout@v4

      # =========================
      # STEP 2: SETUP JAVA
      # =========================
      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      # =========================
      # STEP 3: INSTALL ANDROID SDK (FIXED)
      # =========================
      - name: Install Android SDK
        run: |
          sudo apt update
          sudo apt install -y unzip wget

          mkdir -p $HOME/android-sdk/cmdline-tools
          cd $HOME/android-sdk/cmdline-tools

          wget https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip
          unzip commandlinetools-linux-11076708_latest.zip

          mkdir -p latest
          mv cmdline-tools/* latest/

          echo "ANDROID_HOME=$HOME/android-sdk" >> $GITHUB_ENV
          echo "PATH=$PATH:$HOME/android-sdk/cmdline-tools/latest/bin:$HOME/android-sdk/platform-tools" >> $GITHUB_ENV

      # =========================
      # STEP 4: INSTALL SDK PACKAGES
      # =========================
      - name: Install SDK packages
        run: |
          yes | sdkmanager --licenses
          sdkmanager \
            "platform-tools" \
            "platforms;android-34" \
            "build-tools;34.0.0"

      # =========================
      # STEP 5: INSTALL APKTOOL
      # =========================
      - name: Install Apktool
        run: |
          wget https://bitbucket.org/iBotPeaches/apktool/downloads/apktool_2.9.3.jar -O apktool.jar


      # =========================
      # STEP 6: DECODE APK (OPTIONAL)
      # (Skip kalau repo sudah source)
      # =========================
      - name: Decode APK (if exists)
        run: |
          if [ -f Camera.apk ]; then
            java -jar apktool.jar d Camera.apk -o camera_decoded
          else
            echo "No Camera.apk found, skip decode"
          fi

      # =========================
      # STEP 7: BUILD APK
      # =========================
      - name: Build APK
        run: |
          mkdir -p output

          if [ -d camera_decoded ]; then
            java -jar apktool.jar b camera_decoded -o output/Camera-unsigned.apk
          else
            ./gradlew assembleDebug || ./gradlew assembleRelease
            find . -name "*.apk" -exec cp {} output/ \;
          fi

      # =========================
      # STEP 8: SIGN APK (DEBUG KEY)
      # =========================
      - name: Sign APK
        run: |
          cd output

          keytool -genkeypair -v \
            -keystore debug.keystore \
            -storepass android \
            -alias androiddebugkey \
            -keypass android \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -dname "CN=Android Debug,O=Android,C=US"

          for apk in *.apk; do
            apksigner sign \
              --ks debug.keystore \
              --ks-pass pass:android \
              "$apk"
          done

      # =========================
      # STEP 9: UPLOAD ARTIFACT
      # =========================
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: Camera-APK
          path: output/*.apk
          
