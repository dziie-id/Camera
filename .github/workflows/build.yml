name: Build Camera Wrapper (Manual)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout
      - uses: actions/checkout@v4

      # 2. Java 17
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      # 3. Install Android build tools
      - name: Install Android SDK tools
        run: |
          sudo apt update
          sudo apt install -y aapt zipalign apksigner

      # 4. Prepare build dir
      - name: Prepare build
        run: |
          mkdir -p build
          cp -r wrapper/* build/

      # 5. Compile resources
      - name: Compile resources
        run: |
          aapt compile \
            -o build/res.zip \
            --dir build/res

      # 6. Link APK
      - name: Link APK
        run: |
          aapt link \
            -o build/Camera-unsigned.apk \
            -I /usr/lib/android-sdk/platforms/android-34/android.jar \
            --manifest build/AndroidManifest.xml \
            build/res.zip

      # 7. Zipalign
      - name: Zipalign
        run: |
          zipalign -f 4 \
            build/Camera-unsigned.apk \
            build/Camera-aligned.apk

      # 8. Sign APK
      - name: Sign APK
        run: |
          openssl pkcs8 -topk8 -inform PEM -outform DER \
            -in keystore/Key.pk \
            -out key.pk8 -nocrypt

          apksigner sign \
            --key key.pk8 \
            --cert keystore/Key.x509.pem \
            --out build/Camera-wrapper-signed.apk \
            build/Camera-aligned.apk

      # 9. Upload
      - uses: actions/upload-artifact@v4
        with:
          name: Camera-Wrapper-APK
          path: build/Camera-wrapper-signed.apk
          
