name: Build Aperture Wrapper

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Install Android SDK tools
        run: |
          sudo apt update
          sudo apt install -y android-sdk

      - name: Set env
        run: |
          echo "ANDROID_HOME=/usr/lib/android-sdk" >> $GITHUB_ENV
          echo "ANDROID_SDK_ROOT=/usr/lib/android-sdk" >> $GITHUB_ENV

      - name: Build classes
        run: |
          mkdir -p out/classes
          javac \
            -source 8 -target 8 \
            -classpath $ANDROID_HOME/platforms/android-34/android.jar \
            -d out/classes \
            app/WrapperActivity.java

      - name: Convert to dex
        run: |
          d8 out/classes --output out

      - name: Build unsigned apk
        run: |
          aapt package -f \
            -M app/AndroidManifest.xml \
            -S app/res \
            -I $ANDROID_HOME/platforms/android-34/android.jar \
            -F out/Camera-unsigned.apk

      - name: Add classes.dex
        run: |
          cd out
          zip -u Camera-unsigned.apk classes.dex

      - name: Sign APK
        run: |
          apksigner sign \
            --key keystore/Key.pk8 \
            --cert keystore/Key.x509.pem \
            --out Camera.apk \
            out/Camera-unsigned.apk

      - name: Upload Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: wrapper-${{ github.run_number }}
          files: Camera.apk
