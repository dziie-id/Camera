name: Build Camera Wrapper (Manual)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout
      - uses: actions/checkout@v4

      # 2. Java 17
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      # 3. Install Android SDK Commandline Tools
      - name: Install SDK packages
        run: |
         yes | sdkmanager --licenses
         sdkmanager \
             "platform-tools" \
             "platforms;android-34" \
             "build-tools;34.0.0"

      # 4. Install platform & build-tools
      - name: Install SDK packages
        run: |
          yes | sdkmanager --licenses
          sdkmanager \
            "platform-tools" \
            "platforms;android-34" \
            "build-tools;34.0.0"

      # 5. Prepare build dir
      - name: Prepare sources
        run: |
          mkdir -p build
          cp -r wrapper/* build/

      # 6. Compile resources (aapt2)
      - name: Compile resources
        run: |
          $ANDROID_HOME/build-tools/34.0.0/aapt2 compile \
            --dir build/res \
            -o build/res.zip

      # 7. Compile Java
      - name: Compile Java
        run: |
          mkdir -p build/classes
          javac \
            -classpath $ANDROID_HOME/platforms/android-34/android.jar \
            -d build/classes \
            $(find build/java -name "*.java")

      # 8. Dex
      - name: Dex classes
        run: |
          $ANDROID_HOME/build-tools/34.0.0/d8 \
            build/classes \
            --output build/dex

      # 9. Link APK
      - name: Link APK
        run: |
          $ANDROID_HOME/build-tools/34.0.0/aapt2 link \
            -o build/Camera-unsigned.apk \
            -I $ANDROID_HOME/platforms/android-34/android.jar \
            --manifest build/AndroidManifest.xml \
            --java build/R \
            build/res.zip \
            $(find build/dex -name "*.dex")

      # 10. Sign APK
      - name: Sign APK
        run: |
          openssl pkcs8 -topk8 -inform PEM -outform DER \
            -in keystore/Key.pk \
            -out key.pk8 -nocrypt

          $ANDROID_HOME/build-tools/34.0.0/apksigner sign \
            --key key.pk8 \
            --cert keystore/Key.x509.pem \
            --out build/Camera-wrapper-signed.apk \
            build/Camera-unsigned.apk

      # 11. Upload
      - uses: actions/upload-artifact@v4
        with:
          name: Camera-Wrapper-APK
          path: build/Camera-wrapper-signed.apk
          
