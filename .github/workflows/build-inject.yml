name: Build GCam Go (Anti Double Capture)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      JAVA_OPTS: "-Xmx6g"

    steps:
    # 1Ô∏è‚É£ Checkout repo
    - uses: actions/checkout@v4

    # 2Ô∏è‚É£ Setup Java
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: 17

    # 3Ô∏è‚É£ Setup Android SDK
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    # 4Ô∏è‚É£ Install apktool
    - name: Install apktool (official)
      run: |
        mkdir -p tools
        wget -O tools/apktool.jar https://bitbucket.org/iBotPeaches/apktool/downloads/apktool_2.9.3.jar
        wget -O tools/apktool https://raw.githubusercontent.com/iBotPeaches/Apktool/master/scripts/linux/apktool
        chmod +x tools/apktool
    # 5Ô∏è‚É£ Download GCam Go
    - name: Download GCam Go
      run: |
        mkdir base
        wget -O base/GCamGo.apk \
          https://1-dontsharethislink.celsoazevedo.com/file/filesc/MGCLite_3.8.476835377_V7_ENG.apk

    # 6Ô∏è‚É£ Decode APK
    - name: Decode APK
      run: |
        java -Xmx6g -jar tools/apktool.jar d base/GCamGo.apk -o work --force

    # 7Ô∏è‚É£ Inject smali anti double intent
    - name: Patch smali (anti double capture)
      run: |
        TARGET=$(grep -rl "onCreate(Landroid/os/Bundle;)V" work/smali | head -n 1)
        echo "Patching $TARGET"

        # Tambah static flag di class
        sed -i '/\.super/a\
        .field private static sLaunched:Z' "$TARGET"

        # Inject guard tepat setelah invoke-super
        sed -i '/invoke-super .*onCreate/a\
        sget-boolean v0, Lcom/google/android/apps/camera/CameraActivity;->sLaunched:Z\n\
        if-nez v0, :already_launched\n\
        const/4 v0, 0x1\n\
        sput-boolean v0, Lcom/google/android/apps/camera/CameraActivity;->sLaunched:Z' "$TARGET"

        # Tambah label aman SEBELUM kode lanjutan
        sed -i '/\.locals/a\
        :already_launched' "$TARGET"
    # 8Ô∏è‚É£ Rebuild APK
    - name: Build unsigned APK
      run: |
        export APKTOOL_OPTS="-Xmx6g"
        java -Xmx6g -jar tools/apktool.jar b work -o Camera-unsigned.apk

    # 9Ô∏è‚É£ Sign APK
    - name: Sign APK
      run: |
        BUILD_TOOLS=$(ls $ANDROID_HOME/build-tools | sort -V | tail -n 1)
        $ANDROID_HOME/build-tools/$BUILD_TOOLS/apksigner sign \
          --key keystore/Key.pk8 \
          --cert keystore/Key.x509.pem \
          --out Camera.apk \
          Camera-unsigned.apk

    # üîü Create tag
    - name: Create tag
      run: |
        TAG="v$(date +%Y%m%d-%H%M%S)"
        git tag $TAG
        git push origin $TAG

    # 1Ô∏è‚É£1Ô∏è‚É£ Release
    - name: Upload Release
      uses: softprops/action-gh-release@v2
      with:
        files: Camera.apk
