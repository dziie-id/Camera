name: Check Aperture Camera Build Requirements

on:
  workflow_dispatch:
    inputs:
      detailed_check:
        description: 'Show detailed file checking'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
      device:
        description: 'Target device for camera features'
        required: true
        default: 'sapphire'
        type: string

jobs:
  check-requirements:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: main
        fetch-depth: 0

    - name: Check directory structure
      run: |
        echo "=== DIRECTORY STRUCTURE CHECK ==="
        echo ""
        
        # Check main directories
        echo "1. Required Directories:"
        if [ -d "source/device_xiaomi_sapphire" ]; then
          echo "   âœ“ Device Tree: source/device_xiaomi_sapphire/"
        else
          echo "   âœ— MISSING: Device Tree (source/device_xiaomi_sapphire/)"
        fi
        
        if [ -d "source/vendor_xiaomi_sapphire" ]; then
          echo "   âœ“ Vendor Tree: source/vendor_xiaomi_sapphire/"
        else
          echo "   âœ— MISSING: Vendor Tree (source/vendor_xiaomi_sapphire/)"
        fi
        
        if [ -d "source/kernel_xiaomi_sapphire" ]; then
          echo "   âœ“ Kernel Source: source/kernel_xiaomi_sapphire/"
        else
          echo "   âœ— MISSING: Kernel Source (source/kernel_xiaomi_sapphire/)"
        fi
        
        if [ -d "source/aperture_camera" ]; then
          echo "   âœ“ Aperture Camera: source/aperture_camera/"
        else
          echo "   âœ— MISSING: Aperture Camera (source/aperture_camera/)"
        fi
        
        echo ""
        
    - name: Check device tree camera files
      run: |
        echo "=== DEVICE TREE CAMERA CHECK ==="
        echo ""
        echo "2. Camera Configuration Files in Device Tree:"
        
        if [ -d "source/device_xiaomi_sapphire" ]; then
          # Check for camera overlay files
          CAM_OVERLAY=$(find source/device_xiaomi_sapphire -type f \( -name "*.xml" -o -name "*.mk" \) | grep -i camera | wc -l)
          echo "   Camera-related config files found: $CAM_OVERLAY"
          
          # List specific important files
          echo "   Looking for critical camera files:"
          
          if [ -f "source/device_xiaomi_sapphire/device.mk" ]; then
            CAM_IN_DEVICE=$(grep -i camera source/device_xiaomi_sapphire/device.mk | wc -l)
            echo "   - device.mk has $CAM_IN_DEVICE camera references"
          else
            echo "   âœ— device.mk not found"
          fi
          
          # Check for camera HAL
          if find source/device_xiaomi_sapphire -type f -name "*.rc" | xargs grep -l "camera" >/dev/null 2>&1; then
            echo "   âœ“ Camera service in init.rc files"
          else
            echo "   âš  No camera service found in init.rc"
          fi
          
          # Check for media_profiles.xml
          if find source/device_xiaomi_sapphire -type f -name "*media_profiles*.xml" >/dev/null 2>&1; then
            echo "   âœ“ media_profiles.xml found"
          else
            echo "   âš  media_profiles.xml not found"
          fi
        else
          echo "   Device tree directory not found"
        fi
        
        echo ""
        
    - name: Check vendor tree camera blobs
      run: |
        echo "=== VENDOR TREE CAMERA BLOB CHECK ==="
        echo ""
        echo "3. Camera HAL and Blob Files:"
        
        if [ -d "source/vendor_xiaomi_sapphire" ]; then
          # Count camera-related binaries
          CAM_BLOBS=$(find source/vendor_xiaomi_sapphire -type f \( -name "*.so" -o -name "*.jar" \) | grep -i camera | wc -l)
          echo "   Camera HAL/blobs found: $CAM_BLOBS"
          
          if [ "$CAM_BLOBS" -gt 0 ]; then
            echo "   List of camera libraries:"
            find source/vendor_xiaomi_sapphire -type f \( -name "*.so" -o -name "*.jar" \) | grep -i camera | head -5 | while read file; do
              echo "   - $(basename "$file")"
            done
          else
            echo "   âœ— No camera libraries found"
          fi
          
          # Check for camera HAL specifically
          if find source/vendor_xiaomi_sapphire -type f -name "*camera*.so" | grep -q "camera\."; then
            echo "   âœ“ Camera HAL (.so) found"
          else
            echo "   âœ— Camera HAL not found"
          fi
        else
          echo "   Vendor tree directory not found"
        fi
        
        echo ""
        
    - name: Check kernel camera drivers
      run: |
        echo "=== KERNEL CAMERA DRIVER CHECK ==="
        echo ""
        echo "4. Kernel Camera Drivers:"
        
        if [ -d "source/kernel_xiaomi_sapphire" ]; then
          # Check camera driver directory
          if [ -d "source/kernel_xiaomi_sapphire/drivers/media" ]; then
            echo "   âœ“ Media drivers directory exists"
            
            # Count camera-related drivers
            CAM_DRIVERS=$(find source/kernel_xiaomi_sapphire/drivers -type f -name "*.c" -o -name "*.h" | xargs grep -l "camera\|CAMERA" 2>/dev/null | wc -l)
            echo "   Camera driver files: $CAM_DRIVERS"
          else
            echo "   âœ— Media drivers directory missing"
          fi
          
          # Check for camera sensor drivers
          if find source/kernel_xiaomi_sapphire -type f -name "*camera*" -o -name "*sensor*" | grep -q "Makefile"; then
            echo "   âœ“ Camera sensor build files present"
          else
            echo "   âš  Camera sensor build files may be missing"
          fi
        else
          echo "   Kernel source directory not found"
        fi
        
        echo ""
        
    - name: Check Aperture Camera source
      run: |
        echo "=== APERTURE CAMERA SOURCE CHECK ==="
        echo ""
        echo "5. Aperture Camera Source Code Analysis:"
        
        if [ -d "source/aperture_camera" ]; then
          echo "   Basic structure:"
          
          # Check Android.mk or Android.bp
          if [ -f "source/aperture_camera/Android.mk" ] || [ -f "source/aperture_camera/Android.bp" ]; then
            echo "   âœ“ Build configuration present"
          else
            echo "   âœ— Build configuration missing"
          fi
          
          # Check Java source files
          JAVA_FILES=$(find source/aperture_camera -name "*.java" | wc -l)
          echo "   Java source files: $JAVA_FILES"
          
          # Check resource files
          RES_FILES=$(find source/aperture_camera -path "*/res/*" -type f | wc -l)
          echo "   Resource files: $RES_FILES"
          
          # Check for aux camera references
          echo "   Checking for aux/multi-camera support:"
          AUX_REFS=$(grep -r -i "aux\|dual\|multi\|second\|front" source/aperture_camera --include="*.java" --include="*.xml" | grep -i camera | wc -l)
          echo "   Possible multi-camera references: $AUX_REFS"
          
          if [ "$AUX_REFS" -gt 0 ] && [ "${{ github.event.inputs.detailed_check }}" = "true" ]; then
            echo "   Detailed aux camera references found in:"
            grep -r -l -i "aux\|dual\|multi" source/aperture_camera --include="*.java" --include="*.xml" | head -3 | while read file; do
              echo "   - $file"
            done
          fi
        else
          echo "   Aperture Camera directory not found"
        fi
        
        echo ""
        
    - name: Check build environment requirements
      run: |
        echo "=== BUILD ENVIRONMENT REQUIREMENTS ==="
        echo ""
        echo "6. Required Tools and Dependencies:"
        echo ""
        echo "   A. Android Build Tools:"
        echo "   - Android SDK"
        echo "   - Android NDK"
        echo "   - Java JDK 11/17"
        echo "   - Gradle"
        echo ""
        echo "   B. Device-Specific Requirements:"
        echo "   - Device camera HAL (vendor/lib/hw/camera.*.so)"
        echo "   - Camera service library (vendor/lib/libcameraservice.so)"
        echo "   - Media codec configurations"
        echo "   - Camera permissions (android.hardware.camera*)"
        echo ""
        echo "   C. For Aux Camera Support:"
        echo "   - Camera API2 (android.hardware.camera2)"
        echo "   - Multi-camera HAL API support"
        echo "   - Camera ID enumeration (0 for back, 1 for front, etc.)"
        echo "   - Camera characteristics for each sensor"
        echo ""
        
    - name: Generate summary report
      run: |
        echo "=== SUMMARY REPORT ==="
        echo ""
        echo "Device: Redmi Note 13 4G (${{ github.event.inputs.device }})"
        echo "Check Date: $(date)"
        echo ""
        echo "REQUIREMENTS CHECKLIST FOR STANDALONE APERTURE CAMERA WITH AUX SUPPORT:"
        echo ""
        echo "1. âœ… SOURCE CODE AVAILABILITY"
        echo "   - Aperture Camera source: Must have full Java implementation"
        echo "   - Device tree: Must contain camera overlays and permissions"
        echo "   - Vendor blobs: Must include camera HAL and libraries"
        echo "   - Kernel drivers: Must have camera sensor drivers"
        echo ""
        echo "2. ðŸ”§ BUILD CONFIGURATION NEEDED"
        echo "   - Standalone APK build configuration"
        echo "   - Camera2 API permissions in manifest"
        echo "   - Hardware feature declarations"
        echo "   - ProGuard/R8 configuration for release"
        echo ""
        echo "3. ðŸ“± AUX CAMERA FEATURE REQUIREMENTS"
        echo "   - Multi-camera ID support in HAL"
        echo "   - Camera characteristics for each sensor"
        echo "   - Switching logic between cameras"
        echo "   - Separate preview streams for each camera"
        echo "   - Focus, exposure, flash per camera"
        echo ""
        echo "4. ðŸš« NO ROOT/MODULE DEPENDENCIES"
        echo "   - Must use standard Camera2 API"
        echo "   - No system permissions required"
        echo "   - No Xposed/Magisk modules"
        echo "   - No modifications to system partition"
        echo ""
        echo "5. ðŸ“¦ APK PACKAGING REQUIREMENTS"
        echo "   - Signing with release key"
        echo "   - Version code incrementing"
        echo "   - Asset packaging (icons, strings)"
        echo "   - Multi-ABI support (arm64-v8a, armeabi-v7a)"
        echo ""
        echo "6. âš ï¸ CURRENT STATUS"
        echo "   - Source directories: $(ls -d source/* 2>/dev/null | wc -l) found"
        echo "   - Camera HAL: $(find source/vendor_xiaomi_sapphire -name "*camera*.so" 2>/dev/null | wc -l) libraries"
        echo "   - Build files: $(find source/aperture_camera -name "Android.*" 2>/dev/null | wc -l) configurations"
        echo ""
        echo "RECOMMENDED NEXT STEPS:"
        echo "1. Verify camera HAL compatibility with Camera2 API"
        echo "2. Check if aux cameras are exposed via CameraManager"
        echo "3. Test basic camera functionality with test app"
        echo "4. Create standalone build configuration for Aperture"
        echo "5. Implement camera switcher UI in Aperture"
        echo ""
        echo "NOTES:"
        echo "- Aux camera requires Camera API 2.4+ (Android 9+)"
        echo "- Some devices hide aux cameras via vendor restrictions"
        echo "- Camera characteristics must be complete for each sensor"
        echo "- Focus on logical camera ID switching for user experience"
        echo ""
        echo "=== END OF REPORT ==="
        
    - name: Export results as text
      run: |
        # Create a summary text file
        echo "Aperture Camera Build Requirements Check" > requirements_summary.txt
        echo "Device: Redmi Note 13 4G (${{ github.event.inputs.device }})" >> requirements_summary.txt
        echo "Date: $(date)" >> requirements_summary.txt
        echo "" >> requirements_summary.txt
        echo "SUMMARY:" >> requirements_summary.txt
        echo "1. Source Code: Available" >> requirements_summary.txt
        echo "2. Camera HAL: Needs verification" >> requirements_summary.txt
        echo "3. Aux Support: Requires implementation" >> requirements_summary.txt
        echo "4. Standalone APK: Build config needed" >> requirements_summary.txt
        echo "5. No Root: Using standard Camera2 API" >> requirements_summary.txt
        echo "" >> requirements_summary.txt
        echo "REQUIRED ACTIONS:" >> requirements_summary.txt
        echo "- Verify camera HAL exposes aux cameras" >> requirements_summary.txt
        echo "- Create standalone build for Aperture" >> requirements_summary.txt
        echo "- Add camera switcher UI" >> requirements_summary.txt
        echo "- Test with Camera2 API test app" >> requirements_summary.txt
        
        # Display the summary
        cat requirements_summary.txt
