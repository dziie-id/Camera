name: Build Aperture Camera APK with AUX Support

on:
  workflow_dispatch:
    inputs:
      target_android:
        description: 'Android Target Version'
        required: true
        default: '16'
        type: choice
        options:
          - '16'
          - '17'
      enable_aux:
        description: 'Enable AUX (multiple camera) support'
        required: true
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      enable_hal3:
        description: 'Enable Camera HAL3 features'
        required: true
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  BUILD_DIR: "${{ github.workspace }}/build"
  APERTURE_SRC: "${{ github.workspace }}/aperture_camera"
  PRODUCT_NAME: "sapphire"
  ROM_NAME: "Project_Infinity"
  ANDROID_VERSION: "UpsideDownCake"  # Android 16

permissions:
  contents: write

jobs:
  setup-environment:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup build environment
      run: |
        echo "Setting up Android SDK/NDK environment..."
        
        # Install dependencies
        sudo apt-get update
        sudo apt-get install -y \
          openjdk-17-jdk \
          git \
          wget \
          unzip \
          zip \
          libc6-dev-i386 \
          lib32z1 \
          lib32stdc++6 \
          python3 \
          python3-pip \
          gradle \
          make \
          gcc \
          g++ \
          cmake \
          ninja-build \
          pkg-config
        
        # Setup Java
        sudo update-alternatives --set java /usr/lib/jvm/java-17-openjdk-amd64/bin/java
        sudo update-alternatives --set javac /usr/lib/jvm/java-17-openjdk-amd64/bin/javac
        
        echo "Java version:"
        java -version
        
        echo "Gradle version:"
        gradle --version
        
        # Create directories
        mkdir -p $BUILD_DIR
        mkdir -p $BUILD_DIR/sdk
        mkdir -p $BUILD_DIR/ndk
    
    - name: Download Android SDK
      run: |
        echo "Downloading Android SDK..."
        cd $BUILD_DIR/sdk
        
        # Download command line tools
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
        unzip -q commandlinetools-linux-*.zip
        rm commandlinetools-linux-*.zip
        
        # Setup SDK
        export ANDROID_HOME="$BUILD_DIR/sdk"
        export PATH="$ANDROID_HOME/cmdline-tools/bin:$PATH"
        
        # Accept licenses
        yes | sdkmanager --licenses || true
        
        # Install SDK components for Android 16 (API 35)
        sdkmanager "platforms;android-35" \
                   "build-tools;35.0.0" \
                   "platform-tools" \
                   "extras;android;m2repository" \
                   "extras;google;m2repository"
        
        echo "Android SDK setup complete"
    
    - name: Download Android NDK
      run: |
        echo "Downloading Android NDK..."
        cd $BUILD_DIR/ndk
        
        # Download NDK r25c
        wget -q https://dl.google.com/android/repository/android-ndk-r25c-linux.zip
        unzip -q android-ndk-r25c-linux.zip
        rm android-ndk-r25c-linux.zip
        
        export ANDROID_NDK_HOME="$BUILD_DIR/ndk/android-ndk-r25c"
        export ANDROID_NDK_ROOT="$ANDROID_NDK_HOME"
        export PATH="$ANDROID_NDK_HOME:$PATH"
        
        echo "NDK setup complete"
        echo "NDK version:"
        $ANDROID_NDK_HOME/ndk-build --version

  build-aperture:
    runs-on: ubuntu-latest
    needs: setup-environment
    outputs:
      apk_path: ${{ steps.build.outputs.apk_path }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup environment variables
      run: |
        echo "ANDROID_HOME=$BUILD_DIR/sdk" >> $GITHUB_ENV
        echo "ANDROID_SDK_ROOT=$BUILD_DIR/sdk" >> $GITHUB_ENV
        echo "ANDROID_NDK_HOME=$BUILD_DIR/ndk/android-ndk-r25c" >> $GITHUB_ENV
        echo "ANDROID_NDK_ROOT=$BUILD_DIR/ndk/android-ndk-r25c" >> $GITHUB_ENV
        echo "JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64" >> $GITHUB_ENV
    
    - name: Patch Aperture for AUX support
      run: |
        echo "Patching Aperture Camera for AUX support..."
        
        cd aperture_camera
        
        # Check if we need to patch for AUX cameras
        if [ "${{ github.event.inputs.enable_aux }}" = "true" ]; then
          echo "Enabling AUX camera support..."
          
          # Find and patch AndroidManifest.xml
          if [ -f "AndroidManifest.xml" ]; then
            # Backup original
            cp AndroidManifest.xml AndroidManifest.xml.backup
            
            # Add camera permissions and features for multiple cameras
            cat > AndroidManifest.xml << 'EOF'
<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:tools="http://schemas.android.com/tools"
    package="org.lineageos.aperture"
    android:versionCode="1"
    android:versionName="1.0">

    <uses-permission android:name="android.permission.CAMERA" />
    <uses-permission android:name="android.permission.RECORD_AUDIO" />
    <uses-permission android:name="android.permission.ACCESS_FINE_LOCATION" />
    <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" />
    <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE" />
    
    <!-- For Android 13+ -->
    <uses-permission android:name="android.permission.READ_MEDIA_IMAGES" />
    <uses-permission android:name="android.permission.READ_MEDIA_VIDEO" />
    <uses-permission android:name="android.permission.READ_MEDIA_AUDIO" />
    <uses-permission android:name="android.permission.POST_NOTIFICATIONS" />
    
    <!-- For multiple camera support -->
    <uses-permission android:name="android.permission.SYSTEM_CAMERA" />
    
    <uses-feature android:name="android.hardware.camera" android:required="true" />
    <uses-feature android:name="android.hardware.camera.autofocus" android:required="false" />
    <uses-feature android:name="android.hardware.camera.flash" android:required="false" />
    <uses-feature android:name="android.hardware.camera.front" android:required="false" />
    <uses-feature android:name="android.hardware.camera.level3" android:required="false" />
    
    <!-- For AUX cameras -->
    <uses-feature android:name="android.hardware.camera.any" android:required="true" />
    <uses-feature android:name="android.hardware.camera.concurrent" android:required="false" />
    
    <application
        android:allowBackup="false"
        android:icon="@mipmap/ic_launcher"
        android:label="@string/app_name"
        android:roundIcon="@mipmap/ic_launcher_round"
        android:supportsRtl="true"
        android:theme="@style/Theme.Aperture"
        android:requestLegacyExternalStorage="true"
        android:extractNativeLibs="true"
        tools:ignore="AllowBackup,GoogleAppIndexingWarning"
        tools:targetApi="31">
        
        <activity
            android:name="org.lineageos.aperture.MainActivity"
            android:exported="true"
            android:configChanges="orientation|screenSize|screenLayout|keyboardHidden"
            android:screenOrientation="fullSensor"
            android:theme="@style/Theme.Aperture.NoActionBar">
            <intent-filter>
                <action android:name="android.intent.action.MAIN" />
                <category android:name="android.intent.category.LAUNCHER" />
            </intent-filter>
            <intent-filter>
                <action android:name="android.media.action.VIDEO_CAPTURE" />
                <category android:name="android.intent.category.DEFAULT" />
            </intent-filter>
            <intent-filter>
                <action android:name="android.media.action.IMAGE_CAPTURE" />
                <category android:name="android.intent.category.DEFAULT" />
            </intent-filter>
            <intent-filter>
                <action android:name="android.media.action.IMAGE_CAPTURE_SECURE" />
                <category android:name="android.intent.category.DEFAULT" />
            </intent-filter>
            <intent-filter>
                <action android:name="android.media.action.STILL_IMAGE_CAMERA" />
                <category android:name="android.intent.category.DEFAULT" />
            </intent-filter>
            <intent-filter>
                <action android:name="android.media.action.STILL_IMAGE_CAMERA_SECURE" />
                <category android:name="android.intent.category.DEFAULT" />
            </intent-filter>
        </activity>
        
        <!-- Camera provider for multiple camera support -->
        <provider
            android:name="androidx.core.content.FileProvider"
            android:authorities="org.lineageos.aperture.fileprovider"
            android:exported="false"
            android:grantUriPermissions="true">
            <meta-data
                android:name="android.support.FILE_PROVIDER_PATHS"
                android:resource="@xml/file_paths" />
        </provider>
        
        <!-- Service for camera operations -->
        <service
            android:name="org.lineageos.aperture.camera.CameraService"
            android:exported="false"
            android:enabled="true"
            android:permission="android.permission.BIND_CAMERA_SERVICE" />
            
    </application>

</manifest>
EOF
            echo "✅ AndroidManifest.xml patched for AUX support"
          fi
          
          # Patch camera configuration
          mkdir -p res/xml
          cat > res/xml/camera_aux_config.xml << 'EOF'
<?xml version="1.0" encoding="utf-8"?>
<camera-config>
    <!-- Redmi Note 13 4G NFC (sapphire) camera configuration -->
    <device name="sapphire">
        <!-- Main camera -->
        <camera id="0" facing="back" type="wide">
            <resolution width="1080" height="2400" />
            <feature name="autofocus" value="true" />
            <feature name="flash" value="true" />
            <feature name="ois" value="true" />
        </camera>
        
        <!-- Ultra-wide camera -->
        <camera id="1" facing="back" type="ultrawide">
            <resolution width="800" height="600" />
            <feature name="autofocus" value="false" />
            <feature name="macro" value="true" />
        </camera>
        
        <!-- Macro camera -->
        <camera id="2" facing="back" type="macro">
            <resolution width="640" height="480" />
            <feature name="autofocus" value="true" />
        </camera>
        
        <!-- Depth sensor -->
        <camera id="3" facing="back" type="depth">
            <feature name="bokeh" value="true" />
            <feature name="portrait" value="true" />
        </camera>
        
        <!-- Front camera -->
        <camera id="4" facing="front" type="wide">
            <resolution width="1080" height="2400" />
            <feature name="fixed-focus" value="true" />
            <feature name="hdr" value="true" />
        </camera>
    </device>
    
    <!-- Camera features enabled -->
    <features>
        <feature name="camera.concurrent" value="true" />
        <feature name="camera.aux" value="true" />
        <feature name="camera.hal3" value="${{ github.event.inputs.enable_hal3 == 'true' && 'true' || 'false' }}" />
        <feature name="camera.level3" value="true" />
        <feature name="camera.raw" value="true" />
        <feature name="camera.burst" value="true" />
    </features>
</camera-config>
EOF
          
          echo "✅ Camera configuration created"
        fi
        
        # Enable HAL3 features if requested
        if [ "${{ github.event.inputs.enable_hal3 }}" = "true" ]; then
          echo "Enabling Camera HAL3 features..."
          
          # Create HAL3 properties file
          mkdir -p assets
          cat > assets/camera_hal3.properties << 'EOF'
# Camera HAL3 Configuration for Redmi Note 13 4G NFC
persist.camera.HAL3.enabled=1
persist.vendor.camera.HAL3.enabled=1
persist.camera.eis.enable=1
persist.camera.aux.enable=1
camera.hal1.packagelist=com.skype.raider,com.google.android.talk
camera.hal3.packagelist=org.lineageos.aperture*,com.android.camera*,com.google.android.GoogleCamera*
persist.camera.privapp.list=org.lineageos.aperture
EOF
          
          echo "✅ HAL3 configuration created"
        fi

    - name: Configure build.gradle for Android 16
      run: |
        echo "Configuring build.gradle for Android ${{ github.event.inputs.target_android }}..."
        
        cd aperture_camera
        
        # Create build.gradle if it doesn't exist
        if [ ! -f "build.gradle" ]; then
          cat > build.gradle << 'EOF'
plugins {
    id 'com.android.application'
    id 'org.jetbrains.kotlin.android'
}

android {
    namespace 'org.lineageos.aperture'
    compileSdk 35
    
    defaultConfig {
        applicationId "org.lineageos.aperture"
        minSdk 34
        targetSdk 35
        versionCode 1
        versionName "1.0"
        
        testInstrumentationRunner "androidx.test.runner.AndroidJUnitRunner"
        vectorDrawables {
            useSupportLibrary true
        }
    }
    
    buildTypes {
        release {
            minifyEnabled true
            shrinkResources true
            proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
            signingConfig signingConfigs.debug
        }
        debug {
            debuggable true
            minifyEnabled false
        }
    }
    
    compileOptions {
        sourceCompatibility JavaVersion.VERSION_17
        targetCompatibility JavaVersion.VERSION_17
    }
    
    kotlinOptions {
        jvmTarget = '17'
    }
    
    buildFeatures {
        viewBinding true
        buildConfig true
        compose true
    }
    
    composeOptions {
        kotlinCompilerExtensionVersion '1.5.3'
    }
    
    packagingOptions {
        resources {
            excludes += ['/META-INF/{AL2.0,LGPL2.1}']
        }
    }
    
    // Enable Camera2 API
    useLibrary 'android.hardware.camera2'
}

dependencies {
    implementation 'androidx.core:core-ktx:1.12.0'
    implementation 'androidx.lifecycle:lifecycle-runtime-ktx:2.7.0'
    implementation 'androidx.activity:activity-compose:1.8.0'
    implementation 'androidx.compose.ui:ui'
    implementation 'androidx.compose.ui:ui-graphics'
    implementation 'androidx.compose.ui:ui-tooling-preview'
    implementation 'androidx.compose.material3:material3'
    implementation 'androidx.camera:camera-core:1.3.1'
    implementation 'androidx.camera:camera-camera2:1.3.1'
    implementation 'androidx.camera:camera-lifecycle:1.3.1'
    implementation 'androidx.camera:camera-view:1.3.1'
    implementation 'androidx.camera:camera-extensions:1.3.1'
    implementation 'androidx.camera:camera-video:1.3.1'
    implementation 'androidx.exifinterface:exifinterface:1.3.6'
    implementation 'com.google.android.material:material:1.11.0'
    implementation 'androidx.constraintlayout:constraintlayout:2.1.4'
    implementation 'androidx.navigation:navigation-fragment-ktx:2.7.5'
    implementation 'androidx.navigation:navigation-ui-ktx:2.7.5'
    
    // For multiple camera support
    implementation 'androidx.concurrent:concurrent-futures-ktx:1.1.0'
    implementation 'androidx.lifecycle:lifecycle-livedata-ktx:2.7.0'
    implementation 'androidx.lifecycle:lifecycle-viewmodel-ktx:2.7.0'
    
    testImplementation 'junit:junit:4.13.2'
    androidTestImplementation 'androidx.test.ext:junit:1.1.5'
    androidTestImplementation 'androidx.test.espresso:espresso-core:3.5.1'
    androidTestImplementation 'androidx.compose.ui:ui-test-junit4'
    debugImplementation 'androidx.compose.ui:ui-tooling'
    debugImplementation 'androidx.compose.ui:ui-test-manifest'
}
EOF
        fi
        
        # Create proguard rules
        cat > proguard-rules.pro << 'EOF'
# Add project specific ProGuard rules here.
# You can control the set of applied configuration files using the
# proguardFiles setting in build.gradle.
#
# For more details, see
#   http://developer.android.com/guide/developing/tools/proguard.html

# If your project uses WebView with JS, uncomment the following
# and specify the fully qualified class name to the JavaScript interface
# class:
#-keepclassmembers class fqcn.of.javascript.interface.for.webview {
#   public *;
#}

# Uncomment this to preserve the line number information for
# debugging stack traces.
#-keepattributes SourceFile,LineNumberTable

# If you keep the line number information, uncomment this to
# hide the original source file name.
#-renamesourcefileattribute SourceFile
EOF
        
        # Create gradle.properties
        cat > gradle.properties << 'EOF'
org.gradle.jvmargs=-Xmx2048m -Dfile.encoding=UTF-8
org.gradle.parallel=true
org.gradle.caching=true
android.enableJetifier=true
android.useAndroidX=true
kotlin.code.style=official
EOF

    - name: Build APK
      id: build
      run: |
        echo "Building Aperture Camera APK..."
        
        cd aperture_camera
        
        # Setup paths
        export ANDROID_HOME="$BUILD_DIR/sdk"
        export ANDROID_SDK_ROOT="$ANDROID_HOME"
        
        # Clean previous builds
        ./gradlew clean
        
        # Build APK
        if [ "${{ github.event.inputs.enable_aux }}" = "true" ]; then
          echo "Building with AUX camera support..."
          ./gradlew assembleDebug -PAUX_CAMERA_SUPPORT=true -PCAMERA_HAL3_ENABLED=${{ github.event.inputs.enable_hal3 }}
        else
          echo "Building without AUX camera support..."
          ./gradlew assembleDebug
        fi
        
        # Find the APK file
        APK_PATH=$(find . -name "*.apk" -type f | head -1)
        
        if [ -n "$APK_PATH" ]; then
          echo "APK found at: $APK_PATH"
          
          # Rename APK with version info
          NEW_APK_NAME="Aperture_Camera_${ANDROID_VERSION}_${ROM_NAME}_${PRODUCT_NAME}_AUX-${{ github.event.inputs.enable_aux }}_HAL3-${{ github.event.inputs.enable_hal3 }}.apk"
          cp "$APK_PATH" "$BUILD_DIR/$NEW_APK_NAME"
          
          echo "apk_path=$BUILD_DIR/$NEW_APK_NAME" >> $GITHUB_OUTPUT
          echo "✅ APK built successfully: $NEW_APK_NAME"
        else
          echo "❌ APK not found!"
          exit 1
        fi

    - name: Upload APK as artifact
      uses: actions/upload-artifact@v4
      with:
        name: aperture-camera-apk
        path: ${{ steps.build.outputs.apk_path }}
        retention-days: 7

  create-flashable-zip:
    runs-on: ubuntu-latest
    needs: build-aperture
    if: always()
    
    steps:
    - name: Download APK artifact
      uses: actions/download-artifact@v4
      with:
        name: aperture-camera-apk
        path: ${{ github.workspace }}/artifacts
    
    - name: Create Magisk module
      run: |
        echo "Creating Magisk module for Aperture Camera..."
        
        MODULE_DIR="${{ github.workspace }}/magisk_module"
        mkdir -p $MODULE_DIR
        
        # Module structure
        mkdir -p $MODULE_DIR/system/priv-app/Aperture
        
        # Copy APK
        APK_FILE=$(find ${{ github.workspace }}/artifacts -name "*.apk" | head -1)
        cp "$APK_FILE" "$MODULE_DIR/system/priv-app/Aperture/Aperture.apk"
        
        # Create module.prop
        cat > $MODULE_DIR/module.prop << EOF
id=aperture_camera_aux
name=Aperture Camera with AUX Support
version=v1.0
versionCode=1
author=GitHub Actions
description=Aperture Camera with AUX (multiple camera) support for Redmi Note 13 4G NFC. Built for Project Infinity Android 16 QPR 2.
support=https://github.com/${{ github.repository }}
minMagisk=26400
EOF
        
        # Create post-fs-data.sh for permissions
        cat > $MODULE_DIR/post-fs-data.sh << 'EOF'
#!/system/bin/sh

# Set permissions for Aperture Camera
chmod 755 /data/adb/modu
